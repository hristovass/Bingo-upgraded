<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Bingo ‚Äî Main Menu</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Dark theme styles -->
    <style>
    /* MAIN DARK BACKGROUND */
    body.dark {
        background: linear-gradient(to bottom right, #0f172a, #1e293b) !important;
        color: #e5e7eb !important;
    }

    body.dark main {
        background-color: #0f172a !important; /* dark slate */
        color: #e5e7eb !important;
        border-color: #475569 !important;
    }

    /* Header and footer text */
    body.dark header,
    body.dark footer,
    body.dark h1,
    body.dark h2,
    body.dark h3,
    body.dark label,
    body.dark p,
    body.dark span {
        color: #e5e7eb !important;
    }

    /* Grade + Category cards */
    body.dark #grade-cards div,
    body.dark #category-cards div {
        background-color: #334155 !important; /* slate-700 */
        border-color: #475569 !important;     /* slate-600 */
        color: #e5e7eb !important;
    }

    /* Hover effect */
    body.dark #grade-cards div:hover,
    body.dark #category-cards div:hover {
        background-color: #475569 !important;
        transform: scale(1.03);
    }

    /* Selected cards */
    body.dark #grade-cards .selected,
    body.dark #category-cards .selected {
        background-color: #1e3a8a !important; /* deep blue */
        border-color: #3b82f6 !important;
    }

    /* Add Player button */
    body.dark #add-player-btn {
        background-color: #1d4ed8 !important; /* blue-700 */
        color: white !important;
        border-color: #3b82f6 !important;
    }

    body.dark #add-player-btn:hover {
        background-color: #2563eb !important;
    }

    /* Players box */
    body.dark #players-list div {
        background-color: #334155 !important;
        border-color: #475569 !important;
        color: #e5e7eb !important;
    }

    /* Start button disabled */
    body.dark #start-game.bg-gray-300 {
        background-color: #475569 !important;
        color: #94a3b8 !important;
    }

    /* Start button enabled */
    body.dark #start-game.bg-blue-600 {
        background-color: #2563eb !important;
        color: white !important;
    }

    /* Settings button */
    body.dark #open-settings {
        color: #e5e7eb !important;
        border-color: #9ca3af !important;
        background-color: transparent !important;
    }

    body.dark #open-settings:hover {
        background-color: #111827 !important;
    }

    /* Settings modal overlay */
    body.dark #settingsModal {
        background-color: rgba(0, 0, 0, 0.3) !important;
    }

    /* Settings modal card */
    body.dark #settingsModal > div {
        background-color: #111827 !important;
        color: #e5e7eb !important;
    }

    body.dark #settingsModal h2,
    body.dark #settingsModal label,
    body.dark #settingsModal span {
        color: #e5e7eb !important;
    }

    /* Close settings button */
    body.dark #close-settings {
        background-color: #1f2937 !important;
        color: #e5e7eb !important;
        border: 1px solid #374151 !important;
    }

    body.dark #close-settings:hover {
        background-color: #374151 !important;
    }

    /* Leaderboard button in dark */
    body.dark button[onclick*="leaderboard.html"] {
        background-color: #1e293b !important;
        color: #e5e7eb !important;
        border-color: #334155 !important;
    }

    body.dark button[onclick*="leaderboard.html"]:hover {
        background-color: #0f172a !important;
    }
    .avatar-btn {
    background-color: #e9d5ff; /* —Å–≤–µ—Ç–ª–æ —ô—É–±–∏—á–∞—Å—Ç–∞ */
    color: #4b5563;
    }
    body.dark .avatar-btn {
        background-color: #7c3aed !important;  /* –ø–æ—ò–∞–∫–æ —ô—É–±–∏—á–∞—Å—Ç–∞ */
        color: #f9fafb !important;
        border: 1px solid #a855f7;
    }

    body.dark .avatar-btn:hover {
        background-color: #6d28d9 !important;
    }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-6 flex items-center justify-center font-sans">

<main class="w-full max-w-xl bg-white/80 backdrop-blur-sm rounded-3xl shadow-lg border border-gray-100 p-6 space-y-6">

    <!-- SETTINGS BUTTON -->
    <div class="flex justify-end">
        <button id="open-settings"
                type="button"
                class="px-3 py-1 mb-2 text-sm rounded-full border border-gray-300 hover:bg-gray-100 flex items-center gap-2">
            ‚öô Settings
        </button>
    </div>

    <header class="text-center space-y-2">
        <h1 class="text-3xl font-bold text-gray-800">Bingo kviz üéØ</h1>
        <p class="text-gray-500">Pripravi igro in pritisni gumb za zaƒçetek kvingota!</p>
    </header>

    <!-- Leaderboard -->
    <button
        type="button"
        onclick="window.location.href='leaderboard.html'"
        class="w-full px-6 py-3 border border-gray-300 hover:bg-gray-100 font-semibold rounded-lg transition-colors duration-200">
        üèÜ Poglej lestvico
    </button>

    <!-- AGE GROUPS -->
    <section>
        <label class="block text-sm font-semibold text-gray-700 mb-3">Izberi te≈æavnost</label>
        <div id="grade-cards" class="grid grid-cols-1 sm:grid-cols-3 gap-2"></div>
    </section>

    <!-- PLAYERS -->
    <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Igralci</label>

        <div id="players-list" class="space-y-2 text-sm text-gray-600">
            <p>Ni ≈°e dodanih igralcev.</p>
        </div>

        <button
            id="add-player-btn"
            type="button"
            onclick="window.api.openAddPlayerWindow()"
            class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Dodaj igralca
        </button>
    </div>

    <!-- CATEGORIES -->
    <section>
        <label class="block text-sm font-semibold text-gray-700 mb-3">Izberi predmet (vsaj 1)</label>
        <div id="category-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
    </section>

    <!-- START BUTTON -->
    <div class="pt-4 flex justify-center">
        <button id="start-game"
                type="button"
                disabled
                class="px-6 py-3 bg-gray-300 text-white rounded-lg cursor-not-allowed transition-all">
            Zaƒçni igro ‚ñ∂Ô∏è
        </button>
    </div>

    <footer class="pt-6 text-center text-sm text-gray-500 border-t border-gray-200">
        <span class="font-semibold">Digitalna Brigada</span>
    </footer>

</main>

<!-- SETTINGS MODAL -->
<div id="settingsModal"
     class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-sm space-y-4">
    <h2 class="text-xl font-semibold mb-2">Settings</h2>

    <label class="flex items-center justify-between">
      <span>Dark tema</span>
      <input id="darkToggle" type="checkbox" class="h-5 w-5">
    </label>

    <label class="flex items-center justify-between">
      <span>Muzika v ozadju</span>
      <input id="musicToggle" type="checkbox" class="h-5 w-5">
    </label>

    <label class="flex items-center justify-between">
      <span>Zvoƒçni efekti (odgovori/tajmer)</span>
      <input id="sfxToggle" type="checkbox" class="h-5 w-5">
    </label>

    <div class="flex justify-end gap-2 pt-2">
      <button id="close-settings"
              class="px-3 py-1 rounded-lg border hover:bg-gray-100">Zatvori</button>
    </div>
  </div>
</div>

<!-- Separate JS file for fetching and rendering from backend -->
<script src="index.js"></script>

<script>
/* ---------- CORE STATE ---------- */
const MAX_PLAYERS = 4;

let players = [];
const playerKeys = new Set();
let isGradeSelected = false;
let categoriesSelected = 0;

const selected = { grade: null, category: [] };
const startBtn = document.getElementById("start-game");
const addBtn = document.getElementById("add-player-btn");
const playersList = document.getElementById("players-list");

/* initial load */
loadCategories();
loadGrades();

/* ---------- HELPERS ---------- */
function updateAddPlayerButtonState() {
    if (players.length >= MAX_PLAYERS) {
        addBtn.disabled = true;
        addBtn.classList.add('bg-gray-300','cursor-not-allowed','opacity-60');
        addBtn.classList.remove('bg-blue-600','hover:bg-blue-700');
    } else {
        addBtn.disabled = false;
        addBtn.classList.remove('bg-gray-300','cursor-not-allowed','opacity-60');
        addBtn.classList.add('bg-blue-600','hover:bg-blue-700');
    }
}

function enableStartButton() {
    if (isGradeSelected && categoriesSelected > 0 && players.length > 0) {
        startBtn.disabled = false;
        startBtn.classList.remove("bg-gray-300", "cursor-not-allowed");
        startBtn.classList.add("bg-blue-600", "hover:bg-blue-700", "cursor-pointer");
    } else {
        startBtn.disabled = true;
        startBtn.classList.add("bg-gray-300", "cursor-not-allowed");
        startBtn.classList.remove("bg-blue-600", "hover:bg-blue-700", "cursor-pointer");
    }
}

/* ---------- LOAD CATEGORIES ---------- */
async function loadCategories() {
    const categories = (await window.api.loadMenu()).categories;

    const container = document.getElementById("category-cards");
    container.innerHTML = "";

    categories.forEach(cat => {
        const card = document.createElement("div");
        card.dataset.id = cat.id;
        card.className =
            "p-4 border-2 border-gray-200 rounded-xl cursor-pointer bg-white transition-all";

        card.innerHTML = `<h3 class="font-semibold text-lg">${cat.name}</h3>`;

        card.onclick = () => {
            if (card.classList.contains("border-green-500")) {
                card.classList.remove("border-green-500", "bg-green-50", "selected");
                categoriesSelected--;
            } else {
                card.classList.add("border-green-500", "bg-green-50", "selected");
                categoriesSelected++;
            }
            enableStartButton();
        };

        container.appendChild(card);
    });
}

/* ---------- LOAD GRADES ---------- */
async function loadGrades() {
    const grades = (await window.api.loadMenu()).ageGroups;

    const container = document.getElementById("grade-cards");
    container.innerHTML = "";

    grades.forEach(gr => {
        const card = document.createElement("div");
        card.dataset.id = gr.id;
        card.className =
            "p-4 border-2 border-gray-200 rounded-xl cursor-pointer bg-white transition-all";

        card.innerHTML = `
            <h3 class="font-semibold text-lg">${gr.age_group}</h3>
            <p class="text-sm text-gray-500">${gr.min_age} ‚Äì ${gr.max_age} let</p>
        `;

        card.onclick = () => {
            document.querySelectorAll("#grade-cards div")
                .forEach(x => x.classList.remove("border-blue-500", "bg-blue-50", "selected"));

            card.classList.add("border-blue-500", "bg-blue-50", "selected");

            selected.grade = gr.id;
            isGradeSelected = true;
            enableStartButton();
        };

        container.appendChild(card);
    });
}

/* ---------- AVATARS ---------- */
function openAvatarSelector(playerId) {
    localStorage.setItem("avatar_select_player", playerId);
    window.location.href = "avatar.html";
}

function loadPlayerAvatars() {
    players.forEach(p => {
        const saved = localStorage.getItem("avatar_" + p.id);
        if (saved) {
            const img = document.getElementById("avatar-" + p.id);
            if (img) {
                img.src = "images/avatars/" + saved;
                img.classList.remove("hidden");
            }
        }
    });
}

/* ---------- PLAYER ADDED (from Electron) ---------- */
updateAddPlayerButtonState();

window.api.onPlayerAdded((player) => {
    const key = player?.id ?? `${player.first_name}::${player.last_name}`;

    // prevent duplicates
    if (playerKeys.has(String(key))) {
        const existing = [...playersList.children].find(el => el.dataset?.key === String(key));
        if (existing) {
            existing.classList.add('ring-2','ring-red-400');
            setTimeout(() => existing.classList.remove('ring-2','ring-red-400'), 700);
        }
        return;
    }

    // max 4 players
    if (players.length >= MAX_PLAYERS) {
        updateAddPlayerButtonState();
        return;
    }

    // remove "no players" text
    if (playersList.children[0]?.tagName === "P") {
        playersList.innerHTML = "";
    }

    const row = document.createElement("div");
    row.dataset.key = String(key);
    row.className = "p-2 border rounded-lg bg-white";

  row.innerHTML = `
    <div class="flex justify-between items-center">
        <span>${player.first_name} ${player.last_name}</span>
        <button class="px-2 py-1 text-sm rounded avatar-btn"
                onclick="openAvatarSelector('${key}')">
            Izberi avatar üé®
        </button>
    </div>
    <img id="avatar-${key}"
         class="w-12 h-12 rounded-full mt-2 hidden border-2 border-purple-400">
`;

    playersList.appendChild(row);

    players.push(player);
    playerKeys.add(String(key));

    loadPlayerAvatars();
    enableStartButton();
    updateAddPlayerButtonState();
});

/* ---------- START GAME ---------- */
startBtn.onclick = () => {
    if (startBtn.disabled) return;

    selected.category = [];
    document.querySelectorAll("#category-cards .selected")
        .forEach(c => selected.category.push(c.dataset.id));

    localStorage.setItem("parameters", JSON.stringify({
        grade: selected.grade,
        category: selected.category,
        players: players
    }));

    window.location.href = "game.html";
};
</script>

<script>
/* ---------- SETTINGS (dark / music / sfx) ---------- */
const settingsModal = document.getElementById('settingsModal');
const openSettingsBtn = document.getElementById('open-settings');
const closeSettingsBtn = document.getElementById('close-settings');
const darkToggle = document.getElementById('darkToggle');
const musicToggle = document.getElementById('musicToggle');
const sfxToggle = document.getElementById('sfxToggle');

function applyTheme(theme) {
    document.body.classList.toggle('dark', theme === 'dark');
}

const savedTheme = localStorage.getItem('theme') || 'light';
applyTheme(savedTheme);
darkToggle.checked = savedTheme === 'dark';

const savedMusic = localStorage.getItem('music') || 'on';
musicToggle.checked = savedMusic === 'on';

const savedSfx = localStorage.getItem('sfx') || 'on';
sfxToggle.checked = savedSfx === 'on';

openSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.remove('hidden');
});

closeSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.add('hidden');
});

darkToggle.addEventListener('change', () => {
    const theme = darkToggle.checked ? 'dark' : 'light';
    localStorage.setItem('theme', theme);
    applyTheme(theme);
});

musicToggle.addEventListener('change', () => {
    const music = musicToggle.checked ? 'on' : 'off';
    localStorage.setItem('music', music);
});

sfxToggle.addEventListener('change', () => {
    const sfx = sfxToggle.checked ? 'on' : 'off';
    localStorage.setItem('sfx', sfx);
});
</script>

</body>
</html>
