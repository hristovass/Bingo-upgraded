<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Bingo â€” Main Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-6 flex items-center justify-center font-sans">

<main class="w-full max-w-xl bg-white/80 backdrop-blur-sm rounded-3xl shadow-lg border border-gray-100 p-6 space-y-6">

    <header class="text-center space-y-2">
        <h1 class="text-3xl font-bold text-gray-800">Bingo kviz ğŸ¯</h1>
        <p class="text-gray-500">Pripravi igro in pritisni gumb za zaÄetek kvingota!</p>
    </header>

    <!-- Leaderboard -->
    <button
        onclick="window.location.href='leaderboard.html'"
        class="w-full px-6 py-3 border border-gray-300 hover:bg-gray-100 rounded-lg">
        ğŸ† Poglej lestvico
    </button>


    <!-- AGE GROUPS -->
    <section>
        <label class="block text-sm font-semibold text-gray-700 mb-3">Izberi teÅ¾avnost</label>
        <div id="grade-cards" class="grid grid-cols-1 sm:grid-cols-3 gap-2"></div>
    </section>


    <!-- PLAYERS -->
    <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Igralci</label>

        <div id="players-list" class="space-y-2 text-sm text-gray-600">
            <p>Ni Å¡e dodanih igralcev.</p>
        </div>

        <button
            id="add-player-btn"
            type="button"
            onclick="window.api.openAddPlayerWindow()"
            class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Dodaj igralca
        </button>
    </div>


    <!-- CATEGORIES -->
    <section>
        <label class="block text-sm font-semibold text-gray-700 mb-3">Izberi predmet (vsaj 1)</label>
        <div id="category-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
    </section>


    <!-- START BUTTON -->
    <div class="pt-4 flex justify-center">
        <button id="start-game"
                disabled
                class="px-6 py-3 bg-gray-300 text-white rounded-lg cursor-not-allowed">
            ZaÄni igro â–¶ï¸
        </button>
    </div>


    <footer class="pt-6 text-center text-sm text-gray-500 border-t border-gray-200">
        <span class="font-semibold">Digitalna Brigada</span>
    </footer>

</main>

<script src="index.js"></script>

<script>
// ----------------------------
// Variables
// ----------------------------
let players = [];
const playerKeys = new Set();
let isGradeSelected = false;
let categoriesSelected = 0;
const selected = { grade: null, category: [] };
const startBtn = document.getElementById("start-game");

loadCategories();
loadGrades();


// ----------------------------
// Enable Start
// ----------------------------
function enableStartButton() {
    if (isGradeSelected && categoriesSelected > 0 && players.length > 0) {
        startBtn.disabled = false;
        startBtn.classList.remove("bg-gray-300", "cursor-not-allowed");
        startBtn.classList.add("bg-blue-600", "hover:bg-blue-700", "cursor-pointer");
    }
}


// ----------------------------
// Load Categories
// ----------------------------
async function loadCategories() {
    const categories = (await window.api.loadMenu()).categories;

    const container = document.getElementById("category-cards");
    container.innerHTML = "";

    categories.forEach(cat => {
        const card = document.createElement("div");
        card.dataset.id = cat.id;
        card.className = "p-4 border-2 border-gray-200 rounded-xl cursor-pointer bg-white";

        card.innerHTML = `<h3 class="font-semibold text-lg">${cat.name}</h3>`;

        card.onclick = () => {
            if (card.classList.contains("border-green-500")) {
                card.classList.remove("border-green-500", "bg-green-50", "selected");
                categoriesSelected--;
            } else {
                card.classList.add("border-green-500", "bg-green-50", "selected");
                categoriesSelected++;
            }
            enableStartButton();
        };

        container.appendChild(card);
    });
}


// ----------------------------
// Load Grades
// ----------------------------
async function loadGrades() {
    const grades = (await window.api.loadMenu()).ageGroups;

    const container = document.getElementById("grade-cards");
    container.innerHTML = "";

    grades.forEach(gr => {
        const card = document.createElement("div");
        card.dataset.id = gr.id;
        card.className = "p-4 border-2 border-gray-200 rounded-xl cursor-pointer bg-white";

        card.innerHTML = `
            <h3 class="font-semibold text-lg">${gr.age_group}</h3>
            <p class="text-sm text-gray-500">${gr.min_age} â€“ ${gr.max_age} let</p>
        `;

        card.onclick = () => {
            document.querySelectorAll("#grade-cards div")
                .forEach(x => x.classList.remove("border-blue-500", "bg-blue-50", "selected"));

            card.classList.add("border-blue-500", "bg-blue-50", "selected");

            selected.grade = gr.id;
            isGradeSelected = true;
            enableStartButton();
        };

        container.appendChild(card);
    });
}


// ----------------------------
// Add Player (Called from Electron preload)
// ----------------------------
window.api.onPlayerAdded((player) => {
    const key = player.id;

    if (playerKeys.has(key)) return;
    if (players.length >= 4) return;

    // Remove "Ni igralcev"
    const list = document.getElementById("players-list");
    if (list.children[0]?.tagName === "P") list.innerHTML = "";

    // Player row
    const row = document.createElement("div");
    row.className = "p-2 border rounded-lg bg-white";
    row.innerHTML = `
        <div class="flex justify-between items-center">
            <span>${player.first_name} ${player.last_name}</span>

            <button class="px-2 py-1 text-sm bg-purple-200 rounded"
                    onclick="openAvatarSelector('${key}')">
                Izberi avatar ğŸ¨
            </button>
        </div>

        <img id="avatar-${key}"
             class="w-12 h-12 rounded-full mt-2 hidden border-2 border-purple-400">
    `;

    list.appendChild(row);

    players.push(player);
    playerKeys.add(key);

    loadPlayerAvatars();
    enableStartButton();
});


// ----------------------------
// Avatar selection redirection
// ----------------------------
function openAvatarSelector(playerId) {
    localStorage.setItem("avatar_select_player", playerId);
    window.location.href = "avatar.html";
}


// ----------------------------
// Load Avatars When Returning
// ----------------------------
function loadPlayerAvatars() {
    players.forEach(p => {
        const saved = localStorage.getItem("avatar_" + p.id);
        if (saved) {
            const img = document.getElementById("avatar-" + p.id);
            img.src = "images/avatars/" + saved;
            img.classList.remove("hidden");
        }
    });
}


// ----------------------------
// Start Game
// ----------------------------
startBtn.onclick = () => {
    if (startBtn.disabled) return;

    selected.category = [];
    document.querySelectorAll("#category-cards .selected")
        .forEach(c => selected.category.push(c.dataset.id));

    localStorage.setItem("parameters", JSON.stringify({
        grade: selected.grade,
        category: selected.category,
        players: players
    }));

    window.location.href = "game.html";
};
</script>

</body>
</html>
