<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Bingo ‚Äî Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    @keyframes clickAnimation {
        0%{background:white;}25%{background:red;}50%{background:yellow;}75%{background:lightgreen;}100%{background:lightblue;}
    }

    body.dark {
        background: linear-gradient(to bottom right,#0f172a,#1e293b) !important;
        color:#e5e7eb !important;
    }

    body.dark h1, body.dark h2, body.dark h3,
    body.dark p, body.dark span {
        color:#e5e7eb !important;
    }

    body.dark section {
        background:#1e293b !important;
        color:#e5e7eb !important;
        border-color:#334155 !important;
    }

    body.dark .bg-gradient-to-r {
        background:#1e293b !important;
        color:#f1f5f9 !important;
    }

    body.dark .px-3.py-1.bg-gray-200 {
        background:#334155 !important;
        color:#f1f5f9 !important;
    }

    body.dark .timerBar { background:#3b82f6 !important; }
    body.dark .w-full.bg-gray-200 { background:#1e293b !important; }

    body.dark .qButtons {
        background:#334155 !important;
        color:#f8fafc !important;
        border-color:#475569 !important;
    }

    body.dark .qButtons:hover { background:#475569 !important; }

    body.dark .qButtons.bg-white {
        background:#334155 !important;
        color:#f8fafc !important;
    }

    body.dark #boards > div {
        background:#1e293b !important;
        border-color:#475569 !important;
    }

    body.dark #boards div div { color:#e2e8f0 !important; }

    body.dark .bg-blue-500 { background:#2563eb !important; }
    body.dark .bg-yellow-400 { background:#ca8a04 !important; }

    body.dark #toast {
        background:#1e293b !important;
        color:#f1f5f9 !important;
        border-color:#475569 !important;
    }

    body.dark #winnerModal > div,
    body.dark #winnerModal > div div {
        background:#1e293b !important;
        color:#f8fafc !important;
        border-color:#334155 !important;
    }
    
    body.dark .board-grid div {
        border-color: #64748b !important;   
    }

    body.dark .board-grid div.bg-white {
        background-color: #1e293b !important;
    }

    body.dark .board-grid div.bg-yellow-400 {
        background-color: #ca8a04 !important;
    }

    body.dark [data-player] {
        background-color: #0f172a !important;
        border: 1px solid #475569 !important;
    }

    body.dark section {
        border: 1px solid #475569 !important;
    }

    body.dark .bg-gradient-to-r {
        background: #1e293b !important;       
        color: #e5e7eb !important;            
        border: 1px solid #475569 !important; 
    }

    /* Dark mode ‚Äì –∑–µ–ª–µ–Ω–æ/—Ü—Ä–≤–µ–Ω–æ –∫–æ–ø—á–µ */
    body.dark .qButtons.bg-green-500 {
        background-color: #16a34a !important;
        border-color: #16a34a !important;
        color: #f9fafb !important;
    }

    body.dark .qButtons.bg-red-500 {
        background-color: #ef4444 !important;
        border-color: #ef4444 !important;
        color: #f9fafb !important;
    }

    /* Streak —Ç–µ–∫—Å—Ç –≤–æ dark mode –¥–∞ –µ —ò–∞—Å–µ–Ω */
    body.dark .streak-line {
        color: #fb923c !important;
    }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-6 lg:p-10 font-sans">
<main class="max-w-[1400px] mx-auto space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-center flex-1 text-gray-800">Quiz Bingo! üéØ</h1>
        <button
            onclick="window.location.href='index.html'"
            class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors font-semibold">
            Nova igra
        </button>
    </div>

    <!-- Question Card -->
    <section class="bg-white shadow-2xl rounded-2xl p-6 space-y-6">
        <div class="flex items-center justify-between">
            <span id="turn" class="px-3 py-1 rounded-full bg-blue-500 text-white font-medium"></span>
            <span class="px-3 py-1 rounded-full bg-gray-200 font-medium">‚è±Ô∏è 15s</span>
        </div>

        <!-- Progress bar -->
        <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
            <div class="bg-blue-500 h-2 timerBar" style="width: 100%;"></div>
        </div>

        <div class="flex justify-center">
            <img src="" alt="Question Image" class="hidden" width="200px" height="150px"/>
        </div>

        <!-- Question -->
        <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-lg text-center">
            <p id="question" class="text-lg font-medium"></p>
        </div>

        <!-- Answer buttons -->
        <div class="grid grid-cols-2 gap-4">
            <button id="0" class="qButtons py-4 border rounded-lg hover:scale-105 transition-transform flex items-center justify-center gap-2"></button>
            <button id="1" class="qButtons py-4 border rounded-lg hover:scale-105 transition-transform flex items-center justify-center gap-2"></button>
            <button id="2" class="qButtons py-4 border rounded-lg hover:scale-105 transition-transform flex items-center justify-center gap-2"></button>
            <button id="3" class="qButtons py-4 border rounded-lg hover:scale-105 transition-transform flex items-center justify-center gap-2"></button>
        </div>
    </section>

    <!-- Bingo Boards (dynamic) -->
    <section id="boards" class="grid gap-6 justify-items-center"></section>

    <div class="text-center text-sm text-gray-500 mt-8">
        <span class="font-semibold">Digitalna Brigada</span>
    </div>

    <!-- AUDIO: background music + timer tick + correct/error -->
    <audio id="bgMusic" src="./sounds/background.mp3" preload="auto" loop></audio>
    <audio id="tickSound" src="./sounds/tick.mp3" preload="auto"></audio>
    <audio id="correctSound" src="./sounds/correct.mp3" preload="auto"></audio>
    <audio id="errorSound" src="./sounds/error.mp3" preload="auto"></audio>

    <script>
    (function initTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        document.body.classList.toggle('dark', theme === 'dark');
    })();

    function musicEnabled() {
        return localStorage.getItem('music') !== 'off';
    }

    function sfxEnabled() {
        return localStorage.getItem('sfx') !== 'off';
    }

    const bgMusic = document.getElementById('bgMusic');
    const tickSound = document.getElementById('tickSound');
    const correctSound = document.getElementById('correctSound');
    const errorSound = document.getElementById('errorSound');

    function playBgMusic() {
        if (!musicEnabled() || !bgMusic) return;
        bgMusic.volume = 0.3;
        bgMusic.play().catch(() => {});
    }

    function stopBgMusic() {
        if (!bgMusic) return;
        bgMusic.pause();
        bgMusic.currentTime = 0;
    }

    function playTick() {
        if (!sfxEnabled() || !tickSound) return;
        tickSound.currentTime = 0;
        tickSound.play().catch(() => {});
    }

    function playCorrect() {
        if (!sfxEnabled() || !correctSound) return;
        correctSound.currentTime = 0;
        correctSound.play().catch(() => {});
    }

    function playerror() {
        if (!sfxEnabled() || !errorSound) return;
        errorSound.currentTime = 0;
        errorSound.play().catch(() => {});
    }

    // ---- GAME STATE ----
    let game = [];
    let gameData = [];
    let parameters = {};
    let isCorrectAnswer = false;
    let questionIndex = -1;
    let limitIndex = 20;
    let questionImage = document.querySelector("img");
    let playerIds = [];
    let playerNames = [];
    let playerCount = 0;
    let boards = [];
    let currentPlayer = 0;
    let gameOver = false;
    let toastTimer = null;
    let streaks = []; // üî• streak –ø–æ –∏–≥—Ä–∞—á

    let timerInterval;
    let timeRemaining = 15;  // Timer starts at 15 seconds
    const progressBar = document.querySelector('.timerBar');
    const timerDisplay = document.querySelector('.px-3.py-1.bg-gray-200');

    const buttons = document.getElementsByClassName("qButtons");
    for (var i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', selectedAnswer, false);
    }

    window.onload = function() {
        enterData();
    };

    async function enterData(){
        console.log("Loading game data...");
        parameters = JSON.parse(localStorage.getItem('parameters'));
        playerCount = parameters.players.length;

        for(let i = 0; i < playerCount; i++){
            playerIds.push(parseInt(parameters.players[i].id));
            playerNames.push(`${parameters.players[i].first_name} ${parameters.players[i].last_name}`);
        }

        // init streaks
        streaks = new Array(playerCount).fill(0);

        console.log(parameters.players);
        game = await window.api.startGame(parameters.grade, parameters.category, playerIds);
        gameData = game.questions || [];
        // initial boards from backend
        boards = (game.players || []).map(p => p.board);
        console.log(gameData);
        await (shuffle(gameData));
        console.log("Zmesano: ", gameData);
        limitIndex = gameData.length - 1;
        renderBoards();
        play();
        startTimer();
    }

    function play(){
        if (gameOver) return;
        questionIndex++;
        if(questionIndex > limitIndex){
            questionIndex = 0;
        }
        if(gameData[questionIndex].image_path != undefined){
            questionImage.classList.remove("hidden");
            questionImage.src = "./images/" + gameData[questionIndex].image_path + ".png";
        } else {
            questionImage.classList.add("hidden");
        }
        currentPlayer = questionIndex % playerCount;
        document.getElementById("turn").innerText = playerNames[currentPlayer] + " je na vrsti";
        highlightTurn(currentPlayer);
        document.getElementById("question").innerText = gameData[questionIndex].text;
        document.getElementById("0").innerText = gameData[questionIndex].options[0];
        document.getElementById("1").innerText = gameData[questionIndex].options[1];
        document.getElementById("2").innerText = gameData[questionIndex].options[2];
        document.getElementById("3").innerText = gameData[questionIndex].options[3];
        startTimer();
    }

    async function selectedAnswer(event){
        const button = event.target;
        if (gameOver) return;

        const allBtns = document.getElementsByClassName("qButtons");
        Array.from(allBtns).forEach(b => b.disabled = true);

        const pIdx = questionIndex % playerCount;
        console.log(pIdx, gameData[questionIndex].id, parseInt(button.id));

        try {
            const result = await window.api.answer(
                pIdx,
                gameData[questionIndex].id,
                parseInt(button.id)
            );
            isCorrectAnswer = !!result?.correct;

            if (Array.isArray(result?.board)) {
                boards[pIdx] = result.board;
                updateBoard(pIdx);
            }

            if (isCorrectAnswer) {
                streaks[pIdx] = (streaks[pIdx] || 0) + 1;
                playCorrect();
                button.classList.add("bg-green-500","text-white","border-green-500");
            } else {
                streaks[pIdx] = 0;
                playerror();
                button.classList.add("bg-red-500","text-white","border-red-500");
            }

            // –æ—Å–≤–µ–∂–∏ streak –ø—Ä–∏–∫–∞–∂–∞–Ω –∫–∞—ò –∏–≥—Ä–∞—á–æ—Ç —à—Ç–æ –µ –Ω–∞ —Ä–µ–¥
            highlightTurn(pIdx);

            if (result?.bingo) {
                endGame(pIdx);
            }
        } catch (e) {
            console.error('answer error', e);
            isCorrectAnswer = false;
            playerror();
        }

        setTimeout(function (){
            Array.from(allBtns).forEach(b => {
                b.classList.remove(
                    "bg-green-500","text-white","border-green-500",
                    "bg-red-500","border-red-500",
                    "border-blue-500","bg-blue-50","shadow-md","selected"
                );
                b.classList.add("border-gray-200","bg-white");
                b.style.animation = "";
                b.disabled = false;
            });

            if (!gameOver) play();
        }, 700);
    }

    function shuffle(array) {
        let currentIndex = array.length;
        while (currentIndex != 0) {
            let randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]
            ];
        }
    }

    function startTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        if (gameOver) return;
        timeRemaining = 15;
        updateTimerDisplay(timeRemaining);
        updateProgressBar(timeRemaining);

        playBgMusic();

        timerInterval = setInterval(function() {
            timeRemaining--;
            updateTimerDisplay(timeRemaining);
            updateProgressBar(timeRemaining);

            playTick();

            if (timeRemaining <= 0 && !gameOver) {
                clearInterval(timerInterval);
                stopBgMusic();
                play();
            }
        }, 1000);
    }

    function updateTimerDisplay(time) {
        timerDisplay.innerText = `‚è±Ô∏è ${time}s`;
    }

    function updateProgressBar(time) {
        if(time <= 10 && time > 5) {
            progressBar.classList.add("bg-orange-500");
            progressBar.classList.remove("bg-blue-500");
        } else if(time <= 5) {
            progressBar.classList.add("bg-rose-500");
            progressBar.classList.remove("bg-orange-500");
        } else {
            progressBar.classList.add("bg-blue-500");
            progressBar.classList.remove("bg-rose-500");
        }
        const percentage = (time / 15) * 100;
        progressBar.style.width = `${percentage}%`;
    }

    // --------- Boards rendering ----------
    function renderBoards(){
        const container = document.getElementById('boards');
        container.innerHTML = '';
        const cols = Math.max(1, Math.min(playerNames.length, 4));
        container.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
        playerNames.forEach((name, idx) => {
            const panel = document.createElement('div');
            panel.className = 'w-full max-w-[420px] p-4 rounded-2xl bg-white shadow-md transition-all';
            panel.setAttribute('data-player', idx.toString());
            panel.innerHTML = `
              <div class="mb-3 flex flex-col">
                <h3 class="flex items-center gap-2 font-semibold text-gray-800">
                  <span class="w-3 h-3 rounded-full ${idx===0?'bg-blue-500':'bg-green-500'}"></span> ${name}
                </h3>
                <span class="turn-badge hidden px-2 py-1 mt-1 rounded-full bg-green-500 text-white text-xs font-semibold">Your Turn! ‚ö°</span>
                <p class="streak-line hidden text-xs text-orange-500 font-semibold mt-1">üî• Streak: ${streaks[idx] || 0}</p>
              </div>
              <div class="grid grid-cols-5 gap-2 board-grid"></div>`;
            container.appendChild(panel);
            drawBoardCells(panel.querySelector('.board-grid'), boards[idx] || createEmptyBoard());
        });
        highlightTurn(currentPlayer);
    }

    function createEmptyBoard(){
        const b = Array.from({length:5},()=>Array(5).fill(false));
        b[2][2]=true; // free center
        return b;
    }

    function drawBoardCells(gridEl, board){
        gridEl.innerHTML = '';
        let n=1;
        for(let r=0;r<5;r++){
            for(let c=0;c<5;c++){
                const selected = board?.[r]?.[c];
                const isCenter = r===2 && c===2;
                const cell = document.createElement('div');
                cell.className = `aspect-square rounded-lg flex items-center justify-center ${selected ? (isCenter ? 'bg-yellow-400 text-white' : 'bg-blue-500 text-white shadow') : 'bg-white border-2 border-gray-200'}`;
                cell.textContent = isCenter ? '‚òÖ' : String(n);
                gridEl.appendChild(cell);
                n++;
            }
        }
    }

    function updateBoard(playerIdx){
        const grid = document.querySelector(`[data-player="${playerIdx}"] .board-grid`);
        if (grid) drawBoardCells(grid, boards[playerIdx]);
    }

    function highlightTurn(playerIdx){
        document.querySelectorAll('#boards > div').forEach((panel, idx) => {
            const badge = panel.querySelector('.turn-badge');
            const streakLine = panel.querySelector('.streak-line');

            if (!gameOver && idx === playerIdx){
                panel.classList.add('ring-4','ring-blue-500','scale-105');
                badge?.classList.remove('hidden');

                if (streakLine) {
                    streakLine.textContent = "üî• Streak: " + (streaks[idx] || 0);
                    streakLine.classList.remove('hidden');
                }
            } else {
                panel.classList.remove('ring-4','ring-blue-500','scale-105');
                badge?.classList.add('hidden');
                if (streakLine) {
                    streakLine.classList.add('hidden');
                }
            }
        });
    }

    function disableAnswerButtons(){
        Array.from(document.getElementsByClassName('qButtons')).forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-60','cursor-not-allowed');
        });
    }

    function endGame(winnerIdx){
        gameOver = true;
        clearInterval(timerInterval);
        disableAnswerButtons();
        highlightTurn(-1);
        showWinnerModal(playerNames[winnerIdx]);
    }

    function showWinnerModal(name){
        const modal = document.getElementById('winnerModal');
        const title = document.getElementById('winnerName');
        if (title) title.textContent = name + ' je zmagal! üèÜ';
        modal?.classList.remove('hidden');
    }

    // --- Toast notifications ---
    function showToast(message, type='info'){
        const toast = document.getElementById('toast');
        const text = document.getElementById('toastMessage');
        if (!toast || !text) return;
        text.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.remove('border-green-300','bg-green-50','border-rose-300','bg-rose-50');
        if (type === 'success') {
            toast.classList.add('border-green-300','bg-green-50');
        } else if (type === 'error') {
            toast.classList.add('border-rose-300','bg-rose-50');
        }
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            toast.classList.add('hidden');
        }, 1850);
    }
    </script>

    <!-- Winner Modal -->
    <div id="winnerModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-[90%] max-w-md text-center space-y-4">
        <h2 id="winnerName" class="text-2xl font-bold text-gray-800">Zmagovalec!</h2>
        <p class="text-gray-600">Igra je konƒçana. ƒåestitke!</p>
        <div class="flex gap-3 justify-center">
          <button onclick="window.location.href='index.html'" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Nova igra</button>
          <button onclick="document.getElementById('winnerModal').classList.add('hidden')" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Zapri</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-6 right-6 z-50 px-4 py-3 rounded-xl border shadow-lg bg-white flex items-center gap-3">
        <span id="toastMessage" class="text-sm text-gray-800">Message</span>
        <button onclick="document.getElementById('toast').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">‚úñ</button>
    </div>
</main>

</body>
</html>
